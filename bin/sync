#!/usr/bin/env bash

set -euo pipefail

: "${DROPBOX:?DROPBOX is not set}"

require rsync swab update

colour cyan "==> System update"
update

colour cyan "==> Cleaning \`src\` directory"
swab "$HOME/src"

colour cyan "==> Syncing \`src\` → Dropbox"

SRC_IGNORE=(
  "amber"
  "cargo"
  "just"
  "ruff"
  "uv"
)

exclude_args=(--exclude '.git/')

for directory in "${SRC_IGNORE[@]}"; do
  exclude_args+=(--exclude "$directory/")
done

rsync -auv --delete --info=progress2 \
  "${exclude_args[@]}" \
  "$HOME/src/" \
  "$DROPBOX/src/"

colour green "Sync complete ✔"

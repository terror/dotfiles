#!/usr/bin/env bash

set -euo pipefail

: "${DROPBOX:?DROPBOX is not set}"

require kondo rsync update

colour cyan "==> System update"
update

colour cyan "==> Cleaning \`src\` directory"
kondo "$HOME/src" --all

colour cyan "==> Removing all stray \`node_modules\` directories"
find "$HOME/src" -name 'node_modules' -type d -prune -exec rm -rf '{}' +

colour cyan "==> Syncing \`src\` → Dropbox"

IGNORE_DIRS=(
  "amber"
  "just"
  "ruff"
  "uv"
)

exclude_args=(--exclude '.git/')

for dir in "${IGNORE_DIRS[@]}"; do
  exclude_args+=(--exclude "$dir/")
done

rsync -auv --delete --info=progress2 \
  "${exclude_args[@]}" \
  "$HOME/src/" \
  "$DROPBOX/src/"

colour green "Sync complete ✔"

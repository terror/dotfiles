#!/usr/bin/env bash

set -euo pipefail

cyan()  { printf '\033[36m%s\033[0m\n' "$*"; }
green() { printf '\033[32m%s\033[0m\n' "$*"; }

require() {
  command -v "$1" >/dev/null 2>&1 || {
    echo "Missing required command: $1" >&2
    exit 1
  }
}

: "${DROPBOX:?DROPBOX is not set}"


require rsync
require kondo
require update

cyan "==> System update"
update

cyan "==> Cleaning \`src\` directory"
kondo "$HOME/src" --all

cyan "==> Removing all stray \`node_modules\` directories"
find "$HOME/src" -name 'node_modules' -type d -prune -exec rm -rf '{}' +

cyan "==> Syncing \`src\` → Dropbox"

# Directories in `src` to ignore during sync
IGNORE_DIRS=(
  "amber"
  "just"
  "ruff"
  "uv"
)

exclude_args=(--exclude '.git/')

for dir in "${IGNORE_DIRS[@]}"; do
  exclude_args+=(--exclude "$dir/")
done

rsync -auv --delete --info=progress2 \
  "${exclude_args[@]}" \
  "$HOME/src/" \
  "$DROPBOX/src/"

green "Sync complete ✔"

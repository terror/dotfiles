#!/usr/bin/env python3
# shellcheck disable=SC1071

import json
import subprocess
import sys
from typing import Any, Iterable, NoReturn

def die(message: str) -> NoReturn:
  print(message, file=sys.stderr)
  sys.exit(1)

def get_recipes() -> dict[str, Any]:
  result = subprocess.run(
    ['just', '--dump', '--dump-format', 'json'],
    capture_output=True,
    text=True,
  )

  if result.returncode != 0:
    die('failed to run`just --dump`')

  return json.loads(result.stdout)['recipes']

def select_recipe(recipe_names: Iterable[str]) -> str:
  result = subprocess.run(
    [
      'fzf',
      '--border',
      '--bind', 'ctrl-/:toggle-preview',
      '--ansi',
      '--preview', 'just --show {}',
      '--preview-window', '75%',
    ],
    input='\n'.join(recipe_names),
    capture_output=True,
    text=True,
  )

  if result.returncode != 0:
    sys.exit(0)

  return result.stdout.strip()

def prompt(parameters: list[dict[str, Any]]) -> list[str]:
  arguments: list[str] = []

  for parameter in parameters:
    name = parameter['name']
    default = parameter.get('default')
    kind = parameter.get('kind', 'singular')
    optional = kind == 'star' or default is not None

    if optional:
      message = f'{name} [{default or ""}]: '
    else:
      message = f'{name}: '

    value = input(message).strip()

    if value:
      arguments.append(value)
    elif default:
      arguments.append(default)
    elif not optional:
      die(f'required argument `{name}` not provided')

  return arguments

def main() -> None:
  recipes = get_recipes()
  name = select_recipe(recipes.keys())
  parameters = recipes[name].get('parameters', [])
  arguments = prompt(parameters) if parameters else []
  subprocess.run(['just', name, *arguments])

if __name__ == '__main__':
  main()

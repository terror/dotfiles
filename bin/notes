#!/usr/bin/env bash

EDITOR=${EDITOR:-vim}
NOTE_DIR=${NOTE_DIR:-~/notes}
NOTE_EXT=${NOTE_EXT:-md}
NOTE_FORMAT_COMMAND=${NOTE_FORMAT_COMMAND:-prettier --single-quote --prose-wrap always --write}

enter() {
  cd "$NOTE_DIR" && fd --type f | query \
    --bind "ctrl-d:execute(rm -rf $NOTE_DIR/{})+reload(fd --type f)" \
    --bind "enter:become($EDITOR $NOTE_DIR/{} &> /dev/tty)" \
    --preview "bat --style=numbers --color=always --line-range :500 $NOTE_DIR/{}"
}

format() {
  cd "$NOTE_DIR" && fd --type f | query \
    --bind "ctrl-d:execute(rm -rf $NOTE_DIR/{})+reload(fd --type f)" \
    --bind "enter:become($NOTE_FORMAT_COMMAND $NOTE_DIR/{})" \
    --preview "bat --style=numbers --color=always --line-range :500 $NOTE_DIR/{}"
}

help() {
  echo 'A simple note management CLI powered by fzf, fd, and ripgrep.'
  echo '                                                             '
  echo 'Usage: notes [COMMAND]                                       '
  echo '                                                             '
  echo 'Available commands:                                          '
  echo '  d | daily         Open up todays note                      '
  echo '  h | help          Show this message                        '
  echo '  k | keybindings   View all fzf window keybindings          '
  echo '  s | search        Start a full-text search                 '
}

daily() {
  local note_file
  note_file="$NOTE_DIR/$(date +%F).md"
  touch "$note_file"
  "$EDITOR" "$note_file"
}

keybindings() {
  echo '<ctrl-\> Toggle the preview window'
  echo '<ctrl-c> Exit'
  echo '<ctrl-d> Delete the selected file'
  echo '<ctrl-e> Create a new file whose name is the current query string'
  echo '<ctrl-f> Format the selected file'
  echo '<ctrl-j> Scroll down the preview window'
  echo '<ctrl-k> Scroll up the preview window'
  echo '<ctrl-r> Reload the result buffer'
  echo '<enter>  Edit the selected file'
}

search() {
  INITIAL_QUERY=""

  RG_PREFIX="rg --column --line-number --no-heading --color=always --smart-case "

  export FZF_DEFAULT_COMMAND="$RG_PREFIX '$INITIAL_QUERY'"

  cd "$NOTE_DIR" && query \
    --bind "change:reload:$RG_PREFIX {q} || true" \
    --bind "ctrl-d:execute(rm -rf $NOTE_DIR/{1})+reload(fd --type f)" \
    --bind "enter:become($EDITOR $NOTE_DIR/{1} &> /dev/tty)" \
    --delimiter=':' \
    --disabled \
    --preview "test -n {1} && bat --style=numbers --color=always --highlight-line {2} --line-range :500 $NOTE_DIR/{1} | rg --color=always --passthru --smart-case {q} || true" \
    --query "$INITIAL_QUERY"
}

query() {
  fzf \
    --ansi \
    --bind "ctrl-e:become($EDITOR $NOTE_DIR/{q}.$NOTE_EXT &> /dev/tty)" \
    --bind "ctrl-f:execute($NOTE_FORMAT_COMMAND $NOTE_DIR/{})+reload(fd --type f)" \
    --bind "ctrl-r:reload(fd --type f)" \
    --bind 'ctrl-\:toggle-preview' \
    --bind 'ctrl-c:abort' \
    --bind 'ctrl-k:preview-up,ctrl-j:preview-down' \
    --border \
    --height 90% \
    --min-height 20 \
    --preview-window 75% \
    "$@"
}

main() {
  case "$1" in
  "") enter ;;
  help) help ;;
  d | daily) daily ;;
  k | keybindings) keybindings ;;
  s | search) search ;;
  *)
    echo 'error: Invalid command' >&2
    return 1
    ;;
  esac
}

main "$@"
